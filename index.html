<!DOCTYPE html>
<html>
  <head>
    <title>Kalkulator Himpunan</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="./lib/js/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="./lib/CSS/fontawesome-5.15.4.css" />
    <style>
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        font-family: Arial, sans-serif;
      }
      .set {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      .set .char-input {
        width: 30px;
        margin: 0 10px;
      }
      .set .set-input {
        margin: 0 10px;
      }
      .operations {
        display: flex;
        justify-content: center;
        margin-bottom: 10px;
      }
      .operations button {
        margin: 0 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="set">
        <input
          type="text"
          placeholder="Char Himpunan"
          class="char-input"
          maxlength="1"
        />
        <span>{</span>
        <input type="text" placeholder="Isi Himpunan" class="set-input" />
        <span>}</span> <button class="removeSet">Hapus Himpunan</button>
      </div>
      <div class="set">
        <input
          type="text"
          placeholder="Char Himpunan"
          class="char-input"
          maxlength="1"
        />
        <span>{</span>
        <input type="text" placeholder="Isi Himpunan" class="set-input" />
        <span>}</span> <button class="removeSet">Hapus Himpunan</button>
      </div>
      <button id="addSet">Tambah Himpunan</button>
      <div class="operations">
        <button id="intersection">&#8745;</button>
        <button id="union">&#8746;</button>
        <button id="difference">&#8726;</button>
        <button id="complement">&#8705;</button>
        <button id="symmetricDifference">&#916;</button>
      </div>
      <input type="text" placeholder="Set-Operation" class="set-operation" />
      <button id="calculate">Hitung</button>
      <input type="text" placeholder="Result" class="result" />
    </div>
    <script>
      $(document).ready(() => {
        $("#addSet").click(() => {
          const set = $(
            ` <div class="set"> <input type="text" placeholder="Char Himpunan" class="char-input" maxlength="1"/> <span>{</span> <input type="text" placeholder="Isi Himpunan" class="set-input" /> <span>}</span> <button class="removeSet">Hapus Himpunan</button> </div> `
          );
          $(".container").find("#addSet").before(set);
          toggleRemoveButtons($(".removeSet"));
        });

        function toggleRemoveButtons(removeButtons) {
          if (removeButtons.length > 2) {
            removeButtons.each((index, button) => {
              $(button).css("display", "block");
              $(button).click(() => {
                $(button).parent().remove();
                toggleRemoveButtons($(".removeSet"));
              });
            });
          } else {
            removeButtons.each((index, button) => {
              $(button).css("display", "none");
            });
          }
        }

        toggleRemoveButtons($(".removeSet"));

        $(document).on(
          "click",
          "#intersection, #union, #difference, #complement, #symmetricDifference",
          function () {
            const operation = $(this).text();
            const input = $(".set-operation");
            input.val(input.val() + operation);
          }
        );

        $("#calculate").click(() => {
          const sets = {};
          $(".set").each((index, set) => {
            const char = $(set).find(".char-input").val();
            const values = $(set).find(".set-input").val().split(",");
            sets[char] = values.map(Number).sort((a, b) => a - b);
          });

          function intersection(a, b) {
            let result = [];
            a.forEach((value) => {
              const minCount = Math.min(
                a.filter((x) => x === value).length,
                b.filter((x) => x === value).length
              );
              for (let i = 0; i < minCount; i++) {
                result.push(value);
              }
            });
            const multiSet = {};
            result.forEach((value) => {
              if (multiSet[value]) {
                multiSet[value]++;
              } else {
                multiSet[value] = 1;
              }
            });
            const multiSetResult = Object.entries(multiSet).reduce(
              (acc, [value, count]) => {
                const minCount = Math.min(
                  a.filter((x) => x === Number(value)).length,
                  b.filter((x) => x === Number(value)).length
                );
                for (let i = 0; i < minCount; i++) {
                  acc.push(Number(value));
                }
                return acc;
              },
              []
            );
            return multiSetResult;
          }

          function union(a, b) {
            const multiSet = {};
            a.forEach((value) => {
              if (multiSet[value]) {
                multiSet[value]++;
              } else {
                multiSet[value] = 1;
              }
            });
            b.forEach((value) => {
              if (multiSet[value]) {
                multiSet[value] = Math.max(
                  multiSet[value],
                  b.filter((x) => x === value).length
                );
              } else {
                multiSet[value] = b.filter((x) => x === value).length;
              }
            });
            const multiSetResult = Object.entries(multiSet).reduce(
              (acc, [value, count]) => {
                for (let i = 0; i < count; i++) {
                  acc.push(Number(value));
                }
                return acc;
              },
              []
            );
            return multiSetResult;
          }

          function difference(a, b) {
            return a.filter((value) => !b.includes(value));
          }

          const operation = $(".set-operation").val();
          let result;
          if (operation.length <= 1) {
            result = sets[operation];
          } else {
            const operations = operation.split("");
            result = sets[operations[0]];
            for (let i = 1; i < operations.length; i += 2) {
              const operator = operations[i];
              const nextSet = sets[operations[i + 1]];
              switch (operator) {
                case "∩":
                  result = intersection(result, nextSet);
                  break;
                case "∪":
                  result = union(result, nextSet);
                  break;
                case "∆":
                  result = difference(result, nextSet).concat(
                    difference(nextSet, result)
                  );
                  break;
                case "-":
                  result = difference(result, nextSet);
                  break;
                case "'":
                  result = Object.keys(sets)
                    .filter((key) => key !== operations[0])
                    .reduce((acc, key) => [...acc, ...sets[key]], []);
                  break;
                default:
                  result = [];
                  break;
              }
            }
          }
          $(".result").val(`{${result.join(",")}}`);
        });
      });
    </script>
  </body>
</html>
